name: Code Review

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.lua'
      - 'etc/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.lua'
      - 'etc/**'

jobs:
  lua-check:
    name: Lua Code Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äº diff

      - name: Install Lua and Luacheck
        run: |
          sudo apt-get update
          sudo apt-get install -y lua5.3 luarocks
          sudo luarocks install luacheck

      - name: Run Luacheck
        run: |
          luacheck . --config .luacheckrc --no-color || true
        continue-on-error: true

      - name: Check Lua syntax
        run: |
          echo "Checking Lua syntax..."
          find . -name "*.lua" -not -path "./skynet/*" | while read file; do
            if ! luac -p "$file" 2>/dev/null; then
              echo "âŒ Syntax error in: $file"
              luac -p "$file"
              exit 1
            fi
          done
          echo "âœ… All Lua files have valid syntax"

  code-style:
    name: Code Style Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for common issues
        run: |
          echo "ğŸ” Checking for common code issues..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰è°ƒè¯•ä»£ç æ®‹ç•™
          echo "Checking for debug code..."
          if grep -rn "print(" --include="*.lua" --exclude-dir=skynet --exclude-dir=test . | grep -v "logger" | grep -v "dump"; then
            echo "âš ï¸ Warning: Found print() statements (consider using logger instead)"
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ TODO/FIXME
          echo "Checking for TODO/FIXME comments..."
          if grep -rn "TODO\|FIXME" --include="*.lua" --exclude-dir=skynet .; then
            echo "ğŸ“ Note: Found TODO/FIXME comments"
          fi
          
          # æ£€æŸ¥é•¿è¡Œ
          echo "Checking for long lines (>120 chars)..."
          find . -name "*.lua" -not -path "./skynet/*" -exec awk 'length > 120 {print FILENAME":"NR": line too long ("length" chars)"}' {} \;
          
          echo "âœ… Code style check completed"

  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for security issues
        run: |
          echo "ğŸ”’ Running security checks..."
          
          # æ£€æŸ¥ç¡¬ç¼–ç çš„æ•æ„Ÿä¿¡æ¯
          echo "Checking for hardcoded secrets..."
          if grep -rniE "(password|secret|token|api_key)\s*=\s*['\"][^'\"]+['\"]" --include="*.lua" --exclude-dir=skynet --exclude-dir=test .; then
            echo "âš ï¸ Warning: Possible hardcoded secrets found"
          fi
          
          # æ£€æŸ¥ SQL æ³¨å…¥é£é™©ï¼ˆå¦‚æœæœ‰æ•°æ®åº“æ“ä½œï¼‰
          echo "Checking for potential SQL injection..."
          if grep -rn "string.format.*SELECT\|string.format.*INSERT\|string.format.*UPDATE\|string.format.*DELETE" --include="*.lua" --exclude-dir=skynet .; then
            echo "âš ï¸ Warning: Potential SQL injection risk - use parameterized queries"
          fi
          
          # æ£€æŸ¥ os.execute ä½¿ç”¨
          echo "Checking for os.execute usage..."
          if grep -rn "os.execute\|io.popen" --include="*.lua" --exclude-dir=skynet .; then
            echo "âš ï¸ Warning: Found os.execute/io.popen - ensure input is sanitized"
          fi
          
          echo "âœ… Security check completed"

  diff-review:
    name: Review Changes
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show changed files
        run: |
          echo "ğŸ“‹ Changed Lua files in this PR:"
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- '*.lua' | head -20
          
      - name: Show diff statistics
        run: |
          echo "ğŸ“Š Diff statistics:"
          git diff --stat ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- '*.lua'
